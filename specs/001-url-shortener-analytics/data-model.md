# Data Model: URL Shortener with Click Analytics

**Feature**: `001-url-shortener-analytics`  
**Date**: 2026-02-09  
**Storage**: Cloud Firestore

## Entity Overview

```
urls (collection)
├── {shortCode} (document ID = 7-char nanoid)
│   ├── shortCode: string
│   ├── originalUrl: string
│   ├── createdAt: Timestamp
│   ├── clickCount: number
│   └── clicks (subcollection)
│       └── {autoId}
│           ├── timestamp: Timestamp
│           ├── referrer: string        # "direct" | "search" | "social" | "other"
│           ├── referrerRaw: string     # Full referrer URL
│           └── deviceType: string      # "mobile" | "tablet" | "desktop"
```

## Entity: ShortUrl

**Collection**: `urls`  
**Document ID**: `shortCode` (7-character nanoid, used as document ID for O(1) lookup)

| Field         | Type        | Required | Description                                          | Validation                       |
| ------------- | ----------- | -------- | ---------------------------------------------------- | -------------------------------- |
| `shortCode`   | `string`    | Yes      | 7-char unique identifier (nanoid, custom alphabet)   | Length 7, alphanumeric           |
| `originalUrl` | `string`    | Yes      | The original long URL to redirect to                 | Valid URL format, max 2048 chars |
| `createdAt`   | `Timestamp` | Yes      | When the short URL was created                       | Server timestamp                 |
| `clickCount`  | `number`    | Yes      | Aggregate total click count (atomically incremented) | Initialized to 0, >= 0           |

**Relationships**:

- Has many `ClickEvent` (subcollection `clicks` under this document)

**State Transitions**: None (immutable after creation, only `clickCount` is updated via Cloud Function)

**Indexes Required**:

- `createdAt DESC` — for listing user's links newest first (FR-006)
- `clickCount DESC` — for top links ranking (FR-011)

## Entity: ClickEvent

**Collection**: `urls/{shortCode}/clicks` (subcollection)  
**Document ID**: Auto-generated by Firestore

| Field         | Type        | Required | Description                       | Validation                                  |
| ------------- | ----------- | -------- | --------------------------------- | ------------------------------------------- |
| `timestamp`   | `Timestamp` | Yes      | When the click occurred           | Server timestamp                            |
| `referrer`    | `string`    | Yes      | Categorized referrer source       | Enum: "direct", "search", "social", "other" |
| `referrerRaw` | `string`    | Yes      | Full raw referrer URL or "direct" | String                                      |
| `deviceType`  | `string`    | Yes      | Detected device category          | Enum: "mobile", "tablet", "desktop"         |

**Relationships**:

- Belongs to one `ShortUrl` (parent document)

**State Transitions**: None (immutable — write-once by Cloud Function)

**Indexes Required**:

- `timestamp DESC` — for click trend chart queries (FR-010, FR-013)

## Entity: AnalyticsSummary (Client-Side Computed)

This entity is **not persisted** in Firestore. It is computed client-side by aggregating Firestore query results in React hooks.

| Field               | Type                     | Description                       | Source                                              |
| ------------------- | ------------------------ | --------------------------------- | --------------------------------------------------- |
| `totalLinks`        | `number`                 | Total short URLs created          | Count of `urls` collection                          |
| `totalClicks`       | `number`                 | Sum of all click counts           | Sum of `urls.clickCount`                            |
| `clicksToday`       | `number`                 | Clicks in the current day         | Query `clicks` where `timestamp >= startOfToday`    |
| `dailyClicks`       | `Array<{date, count}>`   | Clicks grouped by day             | Aggregated from `clicks` subcollections             |
| `weeklyClicks`      | `Array<{week, count}>`   | Clicks grouped by week            | Aggregated from `clicks` subcollections             |
| `topLinks`          | `Array<ShortUrl>`        | Links sorted by `clickCount` DESC | Query `urls` ordered by `clickCount` DESC, limit 10 |
| `referrerBreakdown` | `Record<string, number>` | Click counts by referrer category | Aggregated from per-link `clicks`                   |
| `deviceBreakdown`   | `Record<string, number>` | Click counts by device type       | Aggregated from per-link `clicks`                   |

## TypeScript Type Definitions

```typescript
// src/types/url.ts
export interface ShortUrl {
  shortCode: string
  originalUrl: string
  createdAt: Date
  clickCount: number
}

export interface CreateUrlRequest {
  originalUrl: string
}

// src/types/analytics.ts
export interface ClickEvent {
  id: string
  timestamp: Date
  referrer: ReferrerCategory
  referrerRaw: string
  deviceType: DeviceType
}

export type ReferrerCategory = 'direct' | 'search' | 'social' | 'other'
export type DeviceType = 'mobile' | 'tablet' | 'desktop'

export interface AnalyticsSummary {
  totalLinks: number
  totalClicks: number
  clicksToday: number
  dailyClicks: TimeSeriesPoint[]
  weeklyClicks: TimeSeriesPoint[]
  topLinks: ShortUrl[]
}

export interface TimeSeriesPoint {
  date: string // ISO date string "YYYY-MM-DD" or "YYYY-Www"
  count: number
}

export interface LinkAnalytics {
  shortCode: string
  totalClicks: number
  clickTrend: TimeSeriesPoint[]
  referrerBreakdown: Record<ReferrerCategory, number>
  deviceBreakdown: Record<DeviceType, number>
}

// src/types/api.ts
export type AsyncState<T> =
  | { status: 'idle' }
  | { status: 'loading' }
  | { status: 'success'; data: T }
  | { status: 'error'; error: string }
```

## Firestore Composite Indexes

```json
{
  "indexes": [
    {
      "collectionGroup": "urls",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "clickCount", "order": "DESCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}
```

## Data Flow Diagrams

### Create Short URL

```
User Input → validate URL → generateShortCode (nanoid) →
check Firestore (exists?) → setDoc(urls/{code}) → return ShortUrl
```

### Redirect + Track Click

```
GET /{shortCode} → Firebase Hosting rewrite → Cloud Function →
Firestore lookup (urls/{code}) → parse UA + referrer →
write ClickEvent + increment clickCount → 302 redirect
```

### Load Dashboard

```
React mount → query urls (orderBy clickCount DESC, limit 10) →
query all clicks (timestamp >= 30 days ago) → aggregate client-side →
render summary cards + trend chart + top links table
```
